name: Move some images from Docker Hub to Quay.io

env:
  OWNER: ${{ github.repository_owner }}
  PUSH_TO_REGISTRY: ${{ (github.repository_owner == 'jupyter' || github.repository_owner == 'mathbunnyru') && (github.ref == 'refs/heads/main') }}

on:
  pull_request:
    paths:
      - ".github/workflows/registry-move.yml"
  push:
    branches:
      - main
    paths:
      - ".github/workflows/registry-move.yml"
  workflow_dispatch:

jobs:
  update-overview:
    runs-on: ubuntu-latest
    if: github.repository_owner == 'jupyter' || github.repository_owner == 'mathbunnyru'

    steps:
      - name: Checkout Repo ‚ö°Ô∏è
        uses: actions/checkout@v4

      # Using skopeo Docker image allows us to use `--multi-arch all` feature
      - name: Move image from Docker Hub to Quay.io üê≥
        if: env.PUSH_TO_REGISTRY == 'true'
        run: |
          docker run --entrypoint /bin/bash quay.io/skopeo/stable:latest \
          skopeo login quay.io --username ${{ secrets.QUAY_USERNAME }} --password ${{ secrets.QUAY_ROBOT_TOKEN }} && \
          skopeo copy --multi-arch all docker://${{ env.OWNER }}/${{ matrix.image }}:${{ matrix.tag }} docker://quay.io/${{ env.OWNER }}/${{ matrix.image }}:${{ matrix.tag }}

    strategy:
      fail-fast: false
      matrix:
        image:
          [
            docker-stacks-foundation,
            base-notebook,
            minimal-notebook,
            scipy-notebook,
            r-notebook,
            julia-notebook,
            tensorflow-notebook,
            datascience-notebook,
            pyspark-notebook,
            all-spark-notebook,
          ]
        tag:
          [
            1aac87eb7fa5,
            a374cab4fcb6,
            5ae537728c69,
            f3079808ca8c,
            b86753318aa1,
            7285848c0a11,
            ed2908bbb62e,
            4d70cf8da953,
          ]
