name: Apply single platform tags
description: Download the image tar, load it to Docker and apply tags to it

inputs:
  image:
    description: Image name
    required: true
  platform:
    description: Image platform
    required: true
  variant:
    description: Variant tag prefix
    required: true

runs:
  using: composite
  steps:
    - name: Load image to Docker ğŸ“¥
      uses: ./.github/actions/load-image
      with:
        image: ${{ inputs.image }}
        platform: ${{ inputs.platform }}
        variant: ${{ inputs.variant }}

    - name: Download tags file ğŸ“¥
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: ${{ inputs.image }}-${{ inputs.platform }}-${{ inputs.variant }}-tags
        path: /tmp/jupyter/tags/

    - name: Apply tags to the loaded image ğŸ·
      run: |
        python3 -m tagging.apps.apply_tags \
          --registry ${{ env.REGISTRY }} \
          --owner ${{ env.OWNER }} \
          --image ${{ inputs.image }} \
          --variant ${{ inputs.variant }} \
          --platform ${{ inputs.platform }} \
          --tags-dir /tmp/jupyter/tags/
      shell: bash

    - name: Upload SBOM for the image ğŸ§¾
      uses: anchore/sbom-action@a930d0ac434e3182448fe678398ba5713717112a # v0.21.0
      with:
        image: ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ inputs.image }}
        artifact-name: ${{ inputs.image }}-${{ inputs.platform }}-${{ inputs.variant }}-sbom.spdx.json
        upload-artifact-retention: 40

    # This step is needed to prevent pushing non-multi-arch "latest" tag
    - name: Remove the "latest" tag from the image ğŸ—‘ï¸
      run: docker image rmi ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ inputs.image }}:latest
      shell: bash

    - name: Show Docker images ğŸ“¦
      run: docker image ls --all
      shell: bash
